# TIL for 2025-05-28
## アウトプット

サボってたアウトプットを久しぶりにやろうと思ったのに水曜やったからまたサボりそうになったぜ。  
基本アウトプットしてないときは何もしてないゾ。

本日のアウトプット一覧
- 音楽祭感想簡単に
- MusicHourにURL埋め込み機能つけたから解説

役に立ちそうなものあったら持って行ってちょ。

---

### - 音楽祭感想簡単に

主催の方々にLT会に誘ってもらったんで２か月ぐらい前？に参加が決定してました。  
最近お歌を褒められて調子に乗ってるのでのどを自慢しにのど自慢大会にも参加しました。  
のど自慢参加する人たちはリハがあったので前日の１６日から前のりしてぱきらさんとおデートさしてもらいました。

ぱきらさんはZakiさんやぼとふねさんと予定あったんですが、ワイのお泊りする場所のチェックイン時間まで暇やったんで３人にお許し頂いたて一緒に過ごさせてもらいました。  
あざました。

当日リハ～本番はのど自慢＋LTの登壇だったので割と長い時間控室にいさせてもらってましたが、めちゃめちゃ主催者の方々が忙しそうで調整やらステージの準備やらほんまにすげぇなぁって思いました。お疲れさまでした。ありがとうございました。  
みなさんの演奏もマジで感動しました。エモすぎ。

のど自慢とLTは特に緊張とかもなくいつも通りでしたが、いつものイベントより参加されてる方の反応が直に返ってくるのですごく新鮮でした。

出演者の中に漫才やってた方々がいたんですがめちゃめちゃ面白かったです。見れてない人、損したね。ありゃ語り継がれますよ。

自分は割と敏感らしく、場合によってはライブハウスや映画館みたいな薄暗くて激しく光る、音も大きいってとこは苦手になる時もあるんですが、バーがあったり、そこにもモニターがあったり、観客席の隅にも椅子があったりと自分のペースで楽しめる超いい空間だったのでめちゃめちゃ居心地よかったなぁって思いました。  
逃げ場って言ったら変ですけどクールダウンというか休憩できるところがあるってだけでも落ち着いて楽しめるのでマジでよかったです。  
今回は登壇があったので控室にいさせてもらいましたが、普通に参加だけでもちょうどいい感じになるやろうなと思いました。

主催、運営に携わってた方々本当にお疲れ様でした。楽しかったです！！

---

### - MusicHourにURL埋め込み機能つけたから解説

何週間かぶりの更新です。  
こないだのシャッフル交流会とかその前後で校長がディスコードにいらっしゃることがあったので突撃していろいろ相談させていただいてた機能のうちの一つです。  
校長にご意見聞いてたのは

- 番組に実際の配信リンク貼れれば導線になると思うけどどんな表示がいいか
- お便りをOGPで表示できるようにしてほしい（質問箱みたいなやつ）（校長からの要望）

こんな感じでした。  
OGPはこの前実装したんで今回は配信リンクの話です。  
校長にいろいろ伺った結果、配信チャンネルのOGP画像とかDescription表示出来たらいいんじゃないかって感じになったのでその方向で実装することにしました。

とりあえず調べたら以下の記事が出てきたのでおおよそ何をやればいいかはわかりました。  
https://kei-r.hatenablog.com/entry/2021/04/23/173307

- MusicHourのOGP関連の設定
- システムスペックやCI自動テスト設定でのヘッドレスブラウザ
- 同期から聞いてた「スクレイピング」というものの話

これらの事前知識のおかげですんなり理解できたので、やっぱりなんでもやっとくもんやなと思いました。  
全部つながるんよね。

話を戻します。  
最終的に目指す場所はXやNotionにリンク貼り付けたときに出てくるURL埋め込みのカードを番組に表示することです。  
今回はFormがあるのでとりあえずajax的な即時反映は考えずにform入力→画面遷移で表示って感じにします。

記事を読むと、
- URLを入力してもらったらそのURLのページに対して`open-uri`と`nokogiri`を用いてスクレイピングを行い、HTML要素を持ってくる。
- HTML要素の中からtitleやdescriptionといったOGP情報を取得し、DBに保存
- DBに保存したものをviewで見た目整えて表示

って感じでした。  
多分コピペしたらすぐ実装できますし、何やってるかはすごいわかりやすい単純なものでした。

最初は「意外と簡単やしすぐできそう」って思ってたんですがよくよく考えてみると、URL入力してもらうってとこでリンクに不正なパラメータ入れられたり、悪意のあるスクリプトを実行されるリンクを入力される可能性がありますよね。  
さらに、スクレイピングした先のHTMLの中に不正なスクリプトが含まれてる可能性もあったりします。

このあたりを不安に思ったんでAIにいろいろ聞いてたらほぼほぼ想像してた通りの回答が返ってきました。

- SSRFの脆弱性 (Server-Side Request Forgery)　=>　外部から指定されたURLにリクエストを送ることで、内部ネットワークへの不正アクセスが可能になる脆弱性
- リソース消費攻撃　　　　　　　　　　　　　=>　大きすぎるコンテンツ、無限リダイレクト、応答しないサーバーなどにより、アプリケーションのリソースが枯渇する可能性がある
- インジェクション攻撃　　　　　　　　　　　=>　解析したHTMLに悪意あるスクリプトが含まれている可能性がある
- 個人情報の漏洩　　　　　　　　　　　　　　=>　ユーザーが指定したURLへのアクセスログが、サードパーティのサーバーに残り、情報漏洩につながる可能性がある

ここで思いました。自分でやったらミスあるやろうしgemやらAPIを使おう、と。ｗ  
個人開発じゃ考えること多すぎて対応できなさそうやしgemやらAPI使ったほうが丸いやんって。

ってことで探してたんですが探すのへたくそすぎてグダグダやってたらさくぴ様がこんなやつ見つけてきてくれました（校長が教えてくれてた気がしたけど忘れてしまってた・・・）  
https://iframely.com/home  
これのAPIにリンクを渡すとスクレイピングしてOGP情報取得　→　その情報＋その情報から”自動で”埋め込みカードをHTMLで作成してjson形式で情報とHTMLを返すということをしてくれます。  
つまり、**「URL渡したら自動でカードのHTML作成して返信」**してくれるんです。超便利。  
しかもメディア（動画）とかの埋め込みも自動で判別してやってくれる。んもう最高。

なるほど、となっていざ使ってみよう！ってなったんですが、ドキュメント読みなれてなさ過ぎてどうやって使うねんこれ・・・ってなってました。  
そしたらまたさくぴさんがこれじゃないっすかね！！って → https://iframely.com/docs/embedjs

おおなるほど！！と、なりやっと実装が進み始めました。

---

#### iframely使い方講座
教えてくれて使い方まで探してくれたさくぴさんとデバッグ付き合ってくれたやまさかなさんに感謝をしつつ
僭越ながらわたくしめがiframelyの使い方をご説明させていただきます。
 
1. まず https://iframely.com/home でアカウント登録してAPIキーを作成します。

1. 次に`application.html.erb`か、もしくは埋め込みカード表示したいviewにCDNでiframelyに必要なものを読み込みます
そのために以下のようなものを`<head>`のなかもしくは`<body>`の一番上に記述します
```HTML
<-- ドキュメントの書き方 -->
<script async src="//cdn.iframe.ly/embed.js?api_key={API_KEY}"></script>

<-- 今回ワイがやったerbでの実際の記述 -->
<script async src="//cdn.iframe.ly/embed.js?api_key=<%= Rails.application.credentials.dig(:iframely, :api_key) %>&card=small"></script>
<-- ` &card=small`はオプションね  -->
```
 

 
`{API_KEY}`はそのままAPIキーを突っ込みます。結局HTML内に書くのでAPIキー露出しちゃうんですが一応`credentials.yml.enc`に追加してそれを呼び出す形にします。(https://qiita.com/NaokiIshimura/items/2a179f2ab910992c4d39)
※ ちなみに我は**「credentialsファイル過激派」**でenvファイル反対派です。ｗ　二つの違いはかめさんの神記事をどうぞ　→　https://zenn.dev/kame0707/articles/ef2453f31fe236
 
credentialsファイル書くときに大文字小文字ミスってたりしてるせいで呼び出しできないことあるので気をつけようね！！（１敗）（やまさかなさんデバック手伝ってくれてありがと！！）
 
1. んでもって実際に埋め込みカードを表示したいところに以下を追加
```HTML
<-- ドキュメントの書き方 -->
<div class="iframely-embed">
	<div class="iframely-responsive">
		<a data-iframely-url href="{URL_TO_EMBED_HERE}"></a>
	</div>
</div>

<-- {URL_TO_EMBED_HERE} に埋め込みしたいURLを記述する。ということで今回は以下のようにした -->

  <% if @program.url.present? %>
    <div>
      <h2>
        <i class="bi bi-link-45deg"></i>
        リンク
      </h2>
      <div class="iframely-embed">
        <div class="iframely-responsive">
          <a data-iframely-url href="<%= @program.url %>"></a>
        </div>
      </div>
    </div>
  <% end %>
```
 
はい、これで`{URL_TO_EMBED_HERE}`とか`<%= @program.url %>`の部分にURL直書きしてみると埋め込みカードが表示されます。
 
##### ※注意
- HTMLにAPIキー書いちゃってるんで検証ツールから確認できてしまいます。（露出しちゃってて誰でもみれる）[ここ](https://iframely.com/keys/edit/aa28ab957332481a6a4e67)でこのAPIキーに対してアクセスできるドメインの設定をしましょう。設定が終わったらこのドメイン以外からこのAPIキーを使ってアクセスできなくなるので、ローカルからもアクセスできなくなります。

- 一応露出してる場合に使うハッシュ値見たいのがあるらしいのでそれ使ったほうがいいかもです。その場合はCDNの呼び出しを以下のようにしましょう。

```HTML
<script async src="//cdn.iframe.ly/embed.js?key=<%= Rails.application.credentials.dig(:iframely, :api_key) %>&card=small"></script>
<-- api_key= の部分を key= に変更 -->
```
さっきのEdit API keyのページでClient key hash (MD5）って書かれたほうをAPIキーの代わりにcredentialsファイルに保存

 
- APIキー直書きしてテストしてたりした場合その状態でコミットするとプッシュしたときにリポジトリからそのコミットの内容確認出来て、APIキーまでバレちゃうので、そういう場合は気をつけようね
- 今回めんどくさがってCDNで実装してるからこういうちょっとアブナイ感じになってるけどこのAPIはサーバーサイドからも呼び出せるからサーバーサイドで呼び出してjsonからHTML取り出してviewに渡すって方法のほうが完全にAPIキー隠蔽できて安全よ

以上。相談乗ってくれたさくぴさん、やまさかなさんありがとうございました。

---

ということでお二人に助けられながらiframelyの実装が終わりました。
 
んでもってAPIを利用しようとしてた理由のセキュリティにおいてこいつ（iframely）がやってくれてるのは

- URLからのOGP情報の取得
- URLのある程度の検証（アブナイリンクじゃないかとか）
- URLからスクレイピングしてくる際のある程度のサニタイズ

らしい。
けどドキュメントには、URLとか気をつけろよ
みたいなこと書いてあった気がするから、まだちょっと心配やなぁとなるわけです。
 
最初にも書いた「入力されるのが安全なURLか」ってことですよね
んでもってAIと壁打ちしてたらそらもういろいろ教えてくれるから余計不安になってどうしようかなぁとかなるわけですよ
そのあたりの学習もめんどくさいし・・・ｗ
あと、たいていこういうめんどくさいけど重要ことは地道に全部対応してつぶすのもいいんですけど、フレームワークやなんやらで誰かがすでにやってくれてたり
シンプルで割と強力な方法があったりするもんなので、そういうのを聞いたり、純粋にどこまでやるべきかとかを現役の人に意見聞きたくて、とりあえず意見聞けるまで放置かなーとか思ってたら
校長が反応してくれました　↓
https://x.com/massan_E/status/1927257125727646203
 
ということで、ホワイトリスト方式にしてしまおうということで決着しました。
できるだけ多くのURLを最初から入れれるようにしといたら後々便利かなーって感じでしたが、MusicHourの性質上、登録するURLは限られてるので今回はこれでいくことにしました。
 
ここでまた調べるんですがURLのホワイトリスト形式のやり方わかりません。ってことでAIに聞いたらコード出してきちゃったよ・・・ｗ
ここまで結構時間かかってた＋だらだらやってしまってて集中力切れてたし、見た感じよさげやったんでそのまま採用しちゃいました。よくないね。

```ruby

class Program < ApplicationRecord

# 省略

  # 許可するドメインのリスト
  ALLOWED_DOMAINS = [
    "www.youtube.com", "youtube.com", "youtu.be",   # YouTube
    "school.runteq.jp",                             # RUNTEQ
    "www.twitch.tv"                                # Twitch
  ].freeze

  # URLバリデーション
  validates :url, url: { allow_blank: true }, length: { maximum: 2000 }
  validate :validate_url_domain, if: -> { url.present? }

# 省略

  private

  def validate_url_domain
    uri = URI.parse(url)
    unless ALLOWED_DOMAINS.include?(uri.host)
      errors.add(:url, "このドメインは許可されていません。YouTube、Twitch、RUNTEQイベントページのURLを入力してください。")
    end
  rescue URI::InvalidURIError
    errors.add(:url, "無効なURLの形式です")
  end
end

```
 
長くなってきたので簡単な説明にとどめますがやってることはURLの形式チェック、ドメインチェック、長さチェックです。
このバリデーションを通過したものだけProgram（番組）のurlカラムに保存をします。
 
URLの形式チェックに関しては`gem "validate_url"`でやってます
 
`uri = URI.parse(url)`でURLパースした後`uri.host`でドメインとか調べれるのね、知らんかった。くそ便利やんこれ。
 
ホワイトリスト形式にして、そのドメインを信頼してしまう
って感じにしてしまえば、インジェクションだ攻撃だなんだって考えなくてよくなるので結構シンプルかつ強力やなって思いました。
 
ちなみにRUNTEQのアプリはたいしてバリデーションかけてないらしいｗｗｗ
こういうのを気軽にＸ上で聞いてしまったのは失敗かなと思ったけど答えてくれるのはほんとおもろいし勉強になるよね
前もソシャポのランキングアルゴリズムとか教えてくれたし、何ならそれをほぼ丸パクリスペクトさせてもらったし・・・ｗ
 
利用規約に最強のバリデーションがあるからみんなもちゃんと利用規約も読んどこうね。ｗ
 
 
今回はAI使いすぎたんでもうちょっと
分解　→　わからんとこ把握　→　調べて解決
のサイクルを強く意識しないとすぐAI頼って記憶に定着しなくなるのでほんと次から気を付けようと思いました。
 
自分がどこわからんか把握するの大事。
 
そして、さくぴさん、やまさかなさん、校長、いろいろとお手伝いいただきありがとうございました。
 
---

なんかほかにも書きたいことあったけど長くなったし時間もやべぇからいいや・・・ｗ
おやすみなさい

---

メモ：やること、やりたいことリスト

- [ ] 職務経歴書（はよ書け。土曜に面談するからそこでざっくり書く）
- [ ] 卒制で使った技術の記事化（RUNTEQ内で記事少ないやつ優先で）
- [ ] MusicHourの機能改修（ユーザーからの要望。放置しすぎてるやつあるから割と早めに）
- [ ] MusicHourのissueつぶし
- [ ] MusicHourの使い方説明ページ整える
- [ ] 卒制READMEの改修
- [ ] 技術の学習で草を生やすためのリポジトリやシステム作成（Obsidianがええかな？）
- [ ] AtCoderの問題を解いたらリポジトリに履歴が残るような仕組みを作りたい　参考：https://zenn.dev/tishii2479/articles/6b381fb86e0369
  - 参考資料はACになったやつのみって感じやけどテスト通らんかったやつもなぜダメだったかとかメモしてコメント残しておけるようにしたいね
  - 問題解くための環境づくりと問題解いた時の履歴管理が目的
- [ ] 中断してるアルゴリズム学習の再開
- [ ] Gitを中心としたその他技術の学習（本買って読む）（Gitに関しては主に技サポで対応した質問のその後とかを深堀りしていく感じで）

最近これだけやりたいことあるんやけど、どれからやろうとか、どうしようとか
気分的にこれやりたいねんけどちがうもののほうが優先度高いからなぁ・・・で迷って結局やる気失うから一旦視覚化するためにメモとして書いてみた。
 
上のほうが優先度高いねんけど気分は最近脳みそを動かす気持ちよさが足りてないからAtCoderやりたいって感じ
んでどうせならそのAtCoderやアルゴリズム学習でも草はやせたらうれしいからそのためのシステム考えたいなという感じやね
 
やる気でねぇなぁ　→　いったんアルゴリズムで頭動かすかぁ～、**草も生えるし**
 
って感じにしたい。
