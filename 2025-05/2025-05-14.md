# TIL for 2025-05-14
## 5/14 やったこと

動的OGP実装しました。

https://x.com/massan_E/status/1922513007805902937

これ。いろいろ調べて実装終わるまでで５～７時間ぐらいかかっちった。  
大したことやってないのにね(´･ω･)  
気になって深堀りしてた時間がほとんどやった、調べすぎもよくないね。

動的OGPの実装方法としては自分が調べた範囲で分類すると以下の４種類って感じやった。

1. 背景画像を用意　→　バックエンドでMinimagickみたいな画像処理ライブラリ使って文字等を書き込む
2. OGP画像用のHTMLを使ったページを作成する（OGP画像になるものをHTMLで作る）　→　ヘッドレスブラウザでスクリーンショットをとって保存
3. SVG作って画像に変換　→　これをPNGに変換して保存
4. 画像保存用ストレージに設定書いて任せる。あとは呼び出すだけ。

RUNTEQ内でよく見かけるのは１かな、記事もいっぱいあると思う。

2はわかりやすく直感的にページの調整ができるよね、つまり画像の調整が容易。ページ見に行くだけで実際どうなってるか詳細に確認できるし、けどヘッドレスブラウザを起動するリソースとその待機時間とかが気になってくるんじゃないかなと思った。  
あとインフラ関係の知識も必要そうでめんどくさそうやったからそんなに詳しく調べてない。  
cookpadがこれ使ってるらしい。調べたら出てきた（今も使ってんのかは不明）。  
https://techlife.cookpad.com/entry/dynamic-og-image

3は今主流らしいっぽい、知らんけど。Node.jsとかのライブラリ？のSatoriってやつが調べたら出てきたりしたね。  
SVGっていう文字列ベースの画像（あんま詳しいこと知らんけどこういうイメージがある）的なのがあるから、それを文字列として記述しといてそれを動的に変更、画像にしてPNGに変換、保存みたいな感じかなぁ。  
全部の選択肢の中で一番効率的な感じがする（個人の感想）やからゆくゆくは使ってみたいけどRailsで使えるんかこれ？ｗ  
よくわからんけどとりあえず記事はっとく。  
https://qiita.com/Kanahiro/items/1d10b976401ce6a47815

4が今回使った方法。画像ストレージ提供してるサービスに任しちゃう感じ。  
今回利用したcloudinaryの場合やと画像呼び出すURLに直接画像に対して行ってほしい編集の指示みたいなのを含めちゃう感じ。  
編集指示が複雑やったり含めたい情報が長すぎるとURLが長くなりすぎてエラーになったり、URLを渡したりするとエラーになったり、文字書き込みたい場合でもURLに変換する工程の中で内容変わったりみたいなことがあるから結構クセあるけど一番簡単。そして直接バックエンドで処理するわけじゃないから早い、気がする。  
https://catnose.me/notes/cloudinary-dynamic-ogp-image  
https://zenn.dev/rorisutarou/articles/eb64a547619ece  
これ見ながら試行錯誤してURL出力いろいろ試して。

ぱきらさんのこの記事でそのURLを動的に設定するって感じで実装した。超簡単やった。  
https://qiita.com/pakira-56A/items/2993e6dfd3074b14b835

多分画像合成とかもワンチャンできる。

大したことやってないから詳しい実装は以下をみてくだせ。コードは Files changed から。  
https://github.com/massan-E/MusicHour/pull/239

一回やってみてうまく反映されてなかったけど、ページに設定してた認可の設定がログインしてないユーザー見れないみたいなやつやって、Xのクローラーがアクセスできてなかったことが原因やったからそのあたりみんな気をつけようね。
