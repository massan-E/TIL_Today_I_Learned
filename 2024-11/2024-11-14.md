# TIL for 2024-11-14
## 11/14 今日やったこと
- ミニアプリいじいじ
- HR5回目

ミニアプリいじいじはなかなかのゴリラムーブかましてたので**”一回り成長”**できたかなって思います。<br>
HRのこり４回しかないの・・・さびしいねぇ<br>

---

### - ミニアプリいじいじ
起きるの遅かったんですがHRまでにログイン機能とちょっとした問題への対処してました<br>

ログイン機能はニックネームとパスワードだけでのクソほどシンプルなログイン機能なんですが忘れてることが多いのと<br>
カリキュラムでやってた時はコピペで、さらにgemを通してやってたのでほとんどやらなあかんこと忘れてましたｗ<br>
パスワード保存する時はハッシュ化して～セッションにid保存して～ぐらいしか覚えてなかったｗｗ<br>

何やかんや言いながらRails tutorial読んでちょっとずつ思い出しながらコピペしました。ｗ<br>

#### 管理者権限ユーザーの作成
やってる時に管理者権限持ったユーザー作りたいなって思ったんですが、ユーザー作成や編集フォームにそんなものを含めるのもなんか違う気がするし<br>
Renderの無料枠だとrails c使えないからうまいこと隠蔽しながら特定のユーザーに管理者権限付与するにはどうしたらいいかなって悩んでました<br>
（でも今考えたら要らなくなったらその部分は消すなりコメントアウトしたりすればいいからフォームに含めるのが一番楽やったかも）<br>

**結局、専用のルーティング用意して許可したIPのクライアントがそのリクエスト飛ばしたら指定したユーザーにadmin権限が付与されるようにしました**

```Ruby
# Render無料枠でrails cが使えないので一時的な記述。adminユーザーが本番で作成できたら削除すること！

class AdminController < ApplicationController
  before_action :restrict_ip_address, only: [:set_admin]

  def set_admin
    user = User.find(ENV['ADMIN_USER_ID'].to_i) # 環境変数から設定したいユーザーidを取得
    user.admin = true
    if user.save
      flash[:success] = "#{user.name}にadmin権限を付与しました"
    else
      flash[:error] = "admin権限付与に失敗しました"
    end
    redirect_to login_path
  end

  private

  def restrict_ip_address
    client_ip = request.headers['X-Forwarded-For']&.split(',')&.first || request.remote_ip
    puts client_ip

    allowed_ips = ENV['ALLOWED_IPS'].split(',')  # 環境変数からIPアドレスを取得

    unless allowed_ips.include?(client_ip)
      render plain: "アクセスが許可されていません", status: :unauthorized
    end
  end
end
```

```Ruby
Rails.application.routes.draw do
# 省略
  # Render無料枠でrails cが使えないので一時的な記述。admninユーザーが本番で作成できたら削除すること！
  get 'set_admin', to: 'admin#set_admin'

 # 省略
end
```

こんなことやってる人いないっぽかったのでAIに要件投げてちょっといじったり聞いたりしながらこういう感じに落ち着きました<br>

最初はrequest.remote_ipでクライアントのIPを取得しようとしてたけどクライアントとアプリの間にリバースプロキシとかいろいろ挟まってて（リサーチ足りてなくてあんま分かってない）ちゃんと取得できなかったので<br>

```Ruby
.headers['X-Forwarded-For']&.split(',')&.first
```

この記述でHTTPヘッダーから、通過した一連のipとってきてそれの一番最初がクライアントのIPになるからそれを取得するって感じにしました<br>

参考記事：https://mrk21.hatenablog.com/entry/2020/08/06/214922<br>

でもまだコレでも先頭に偽装IP入れ込まれちゃうとリクエスト飛んじゃうので完璧ではないです<br>

環境変数に入れたIP特定したり、環境変数に入れたユーザーidのユーザーにしか付与されなかったりするのでよほどのことが無い限りは大丈夫じゃないかなと思いますが・・・ｗ<br>
ゴリラ戦法やしだいぶ無駄な努力してますが面白かったし勉強になりました<br>

## - HR5回目
アプリアイデア出し会みたいな感じでした<br>
自分は０→１がめっちゃ苦手だったので今日教えていただいたことがかなり役に立ちました<br>
やろっかなーとぼんやり考えてたことも割と現実味を帯びてきたし、他の人のアイディアから色々と学ぶことも多かったので勉強になりました<br>

HR中、HR後の二次会で同期のいろんな人のアプリアイデア聞いてると面白そうなもの多くて今からめっちゃ楽しみです<br>
一緒に頑張って作り上げて卒業しましょう！<br>

---

### やることリスト
- [ ] RenderCLIの続き（権限なくて編集できない問題解決する）
- [ ] Rails生成のDockerfile、RenderCLIのうまくいかないところを誰かに聞くor技術面談行く
- [ ] ミニアプリのログイン機能を中心に続きを作る（あとはクッキーに保存するやつ）
- [ ] usernameでログインするのにuniqueのバリデーション忘れてたからその辺考えながらやる

---

HR5回目終わるなんてマジで時間経つの早いっすねぇ・・・今日確認したら卒業目標日まであと２２日とか書いてて「無理やん、ワロタ」ってなりました<br>
ミニアプリいじってなかったらワンチャン行けてたかもですねｗ<br>
卒業制作に２～３か月って考えるとミニアプリとかで遊んでられるのもあと１か月ちょいぐらいしかないですね<br>
すぐ実装方法がイメージできるミニアプリですら２週間ちょいぐらいかかってるから全くイメージできないものの実装＋キャッチアップの時間とか考えたくもないですねｗ<br>

ただ、ミニアプリやってて分かったんですが実装になるといくら時間かかってもそんなに集中力切れないんでそこでのスピードアップはできそうやなと思います<br>
座学は嫌いで手が止まるのでプラマイゼロぐらいかもしれませんがｗｗ<br>

とりあえずグダグダしそうになったらROMって本気出します、それまではディスコ入りながら頑張りますｗ<br>
今のとこミニアプリ楽しいので適当に頑張ります。それではおやすみなさい。<br>