# TIL for 2024-11-22
## やったこと 11/21 & 22
- アプリつづき
 - 親テーブル削除問題（すみさんへ　解決しました :partyparrot: ）
 - flashが表示されない
 - 招待機能
 - 認可機能

---

### - 11/21

#### - 認可機能
認可gemにソーサリーとかが前提にあると思ってたからgem使わずにコントローラーに認可機能作ってました<br>
current_userメソッドがあればよかったみたいやから時間できたらgem使ってやり直します<br>
gem使わないとややこしくてね・・・ｗ<br>

#### - 招待機能
複数のユーザーで同じ掲示板のようなものを操作できるが、hostユーザー(最初に掲示板作ったユーザー)が許可または招待したユーザーだけが一緒に編集できるようにしたいってのがこの機能です<br>

パスワードリセット機能を応用して作りました<br>
- その掲示板（program）にトークンのハッシュ化したヤツ保存して、それを保存した時間も保存<br>
- ハッシュ化前のトークンを含めた招待リンク（踏むとユーザーとprogramの関係を更新するアクションにつながるページに遷移する）<br>
を生成してhostユーザー自身に招待したいユーザーに送ってもらう。<br>
- 招待されたユーザーがリンクを踏むとリンクに含まれたトークンをハッシュ化したものとprogramに保存されたハッシュ化したヤツを比較し同じものならアクセス許可<br>
- さらにそのトークンが保存された時間から一時間経過してたらアクセス拒否<br>
- 2つの評価が通ったら招待されたユーザーをprogramに関連付けるアクションを飛ばせるようにする<br>

って感じでした<br>

---

### - 11/22
#### - flash表示されない問題
flashの見た目がおかしかったのでCSSを弄ったりコントローラー確認した結果<br>
```
redirect_to hoge_path, success: "成功！"
```
みたいに書いてたのがよくなかったっぽいです<br>
successとalert以外やと以下のように書かないとダメみたいです<br>
```
redirect_to hoge_path, flash: { key: "message" } # noticeとalert以外はこんな感じで書く
redirect_to hoge_path, flash: { sccess: "huga" }
```
コレどっかでやった気がするけど忘れてたなｗ<br>
https://qiita.com/d0ne1s/items/ac50363cd2e6027e53e1<br>

#### - 親テーブル削除問題
ER図
[![Image from Gyazo](https://i.gyazo.com/23744bc948ade8e6f57a8599b1ba8397.png)](https://gyazo.com/23744bc948ade8e6f57a8599b1ba8397)<br>
userを削除するとその子テーブル（program,letterbox）の関連するレコードも削除されてしまうのですが、その中の一つの子テーブル（letter）のレコードを削除したくありませんでした。そうなると子テーブルの中の外部キーにnullが入ってしまって制約に違反するのでRailsがエラー吐いて削除できませんでした。<br>

letterの外部キーが保存されてるカラムにnullを許可するような設定をすればよさそうかなと思ったのですが設計的にletter作成時点では外部キーにはnullがはいってほしくなかったので、「作成時のバリデーションでnullは弾けるけどuser以外の親テーブルの関連するレコードが削除された場合にはnullを許可する」みたいな感じになるのが理想でした。<br>

よってこの案はいったん却下<br>

その次に思いついたのが削除するもののidがはいってたとこに０入れときゃいんじゃね？って案でした<br>
DBは１オリジンなのでid０のものは存在しないから変にほかのモノと関連づく心配ないしもともと数字が入ってたんやから0も入れられるんじゃね？って考えでした。<br>
結果は「そんなidのレコードねぇから意味分かんねぇよ」ってRailsさんに言われてＮＯを突き付けられました。そうですね、すいませんでした。ｗ<br>


ちょうどアプリの感想を言いに来てくれた[すみさん](https://chat.runteq.jp/runteq/channels/times_53b_kawashima_sumio)も巻き込んでいろいろ考えてたら<br>
「中間テーブル作ってそこに関連付け情報を保存すればletterのテーブルから外部キーの部分を排除できるので求めてた挙動になるのでは？」とアドバイスをもらいました<br>
こんな感じ<br>
[![Image from Gyazo](https://i.gyazo.com/92d993fcddb89acc162f415648d969c9.png)](https://gyazo.com/92d993fcddb89acc162f415648d969c9)

なるほど！っと思ったんですがリレーション組みなおしたりするしその結果コントローラー書き直さないといけなくてちょっとめ・・・だったので一旦保留しました<br>

すみさんがお休みになられてからすぐぐらいに<br>
https://dorarep.page/articles/rails-dependent
こういうの発見したので<br>
```
has_many :letters, dependent: :nullify
```
こんな感じで設定してみたら<br>
作成時のバリデーションではnullはじかれるけど親テーブルの関連レコードが削除された場合にはしっかりnullがはいってました<br>
これで求めてた挙動にできたので万々歳！<br>

#### - クエリ走りすぎる問題
パーシャル内でif current_user == @program.userとかで場合分けからの表示/非表示やってると複数表示した場合にcurrent_userが毎回呼び出されるからクエリがめっちゃ走るので、「よくねぇなぁ」と思って思い付きでリファクタリングしてました<br>
結局パーシャルを呼び出す親viewファイル？って言うんかわからんけどそこで一回だけcurrent_userを呼び出してパーシャルに渡せばいんじゃね？って感じになりました<br>
```
<div class="row g-4">
      <%= render partial: "programs/program", 
                collection: @programs, 
                as: :program,
                locals: { current_user: current_user } %>
</div>
```
が、これでもパーシャル内で結局そのcurrent_userと他のuserを比べるために他のユーザーの方を呼び出すので回数は減ったけどクエリが発生してしまってます<br>

なので今度は一緒に話してたディングーさんと色々はなして<br>
helperで表示/非表示のためのロジック評価してその結果として同じ変数に違う値（表示するパーシャル/非表示にするパーシャル）を入れたらいんじゃね？って言われました<br>
これもなるほど！ってなったのですが今日はもう眠くて実装できそうにないので明日試してみますｗ<br>

---

二日貯めるとろくなことないですね・・・何やったか忘れてるし眠すぎるし長くなるからかいつまんでかくと今度は理解しにくくなるｗ<br>
今日とぴさんの読みやすい技術記事の書き方講座うけたとは思えない殴り書きです、ごめんなさい。orz<br>
アプリもほぼ完成＆明日は土曜なのでお休みにするかもです。おやすみなさい！<br>



